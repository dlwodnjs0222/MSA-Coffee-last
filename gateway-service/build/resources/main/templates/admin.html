<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="/css/style.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/navbar :: navbarFragment}"></div>

<div class="container mt-4">
    <h2>사용자 관리</h2>
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>사용자명</th>
                        <th>이메일</th>
                        <th>역할</th>
                        <th>작업</th>
                    </tr>
                    </thead>
                    <tbody id="userTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">사용자 정보 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">사용자명</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">역할</label>
                        <select class="form-select" id="editRole" required>
                            <option value="USER">USER</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">저장</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="/js/common.js"></script>

<script>
    let editModalInstance;

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {

        if (!checkPagePermission(['ADMIN'])) return;// 1. 권한 체크 (이름 변경됨)

        initializeModal(); // 2. 모달 초기화
        loadUsers();       // 3. 유저 목록 로드
    });

    // ★ 핵심 수정: 네비바 조작 코드를 제거하고 순수 권한 체크만 수행
    // (네비바 UI는 이제 common.js가 알아서 처리합니다)
    function checkAdminRole() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        if (role !== 'ADMIN') {
            alert('관리자 권한이 필요합니다.');
            window.location.href = '/';
        }
    }

    // 모달 위치 이동 및 인스턴스 생성
    function initializeModal() {
        const modalEl = document.getElementById('editModal');
        if (modalEl) {
            document.body.appendChild(modalEl);
            editModalInstance = new bootstrap.Modal(modalEl);
        }
    }

    // 사용자 목록 로드
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            if (response.ok) {
                const users = await response.json();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-2" onclick="showEditModal(${user.id}, '${user.username}', '${user.email}', '${user.role}')">수정</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">삭제</button>
                    </td>`;
                    tbody.appendChild(tr);
                });
            }
        } catch (error) { console.error(error); }
    }

    // 수정 모달 표시
    function showEditModal(id, username, email, role) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;

        if (editModalInstance) {
            editModalInstance.show();
        } else {
            alert("모달 오류");
        }
    }

    // 사용자 정보 수정
    async function updateUser() {
        const id = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value;
        const email = document.getElementById('editEmail').value;
        const role = document.getElementById('editRole').value;

        try {
            const response = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ username, email, role })
            });

            if (response.ok) {
                editModalInstance.hide();
                loadUsers();
            } else {
                alert('수정 실패');
            }
        } catch (error) { console.error(error); }
    }

    // 사용자 삭제
    async function deleteUser(userId) {
        if (!confirm('삭제하시겠습니까?')) return;
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            if (response.ok) loadUsers();
        } catch (error) { console.error(error); }
    }

    // ★ 로그아웃 버튼 리스너 제거됨 (common.js가 자동으로 처리)
</script>
</body>
</html>