<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>로그인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }
        .btn-login {
            width: 100%;
            padding: 10px;
        }
        .register-link {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-container">
            <h2 class="login-title">로그인</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">사용자명</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">비밀번호</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-login">로그인</button>
                </div>
                <div class="register-link">
                    <a href="/register">계정이 없으신가요? 회원 가입</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // ★★★ 수정됨: JSON 형식으로 데이터를 만듭니다. ★★★
            const loginData = {
                username: username,
                password: password
            };

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData),
                    // ★★★ 이 옵션이 중요합니다! ★★★
                    // 서버가 보낸 쿠키를 브라우저에 저장하고,
                    // 다음 요청 때 쿠키를 서버로 함께 보냅니다.
                    credentials: 'include'
                });

                if (response.ok) {
                    // 로그인 성공! 서버로부터 받은 데이터를 활용 (예: 토큰 저장)
                    const data = await response.json();
                    console.log("서버 응답:", data);

                    // 임시: 권한 체크 JS를 위해 필요한 정보 저장
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('role', data.role);
                    localStorage.setItem('token', 'dummy-token'); // 나중엔 실제 JWT 토큰으로 대체

                    window.location.href = '/';
                } else {
                    // ★★★ 여기가 수정된 부분입니다 ★★★
                    // 1. 서버에서 보낸 에러 메시지를 텍스트로 받습니다.
                    //    (예: "아이디 또는 비밀번호가 잘못되었습니다.")
                    const errorText = await response.text();

                    // 2. 서버의 에러 응답이 JSON 형식일 수도 있으므로, 파싱을 시도해봅니다.
                    //    (Spring Boot 기본 에러 응답인 timestamp 등을 거르기 위함)
                    let userFriendlyMsg;
                    try {
                        // 만약 JSON이라면 파싱해서 'message' 필드나 우리가 의도한 메시지를 추출합니다.
                        const errorJson = JSON.parse(errorText);

                        // 서버에서 명시적으로 보낸 메시지가 있는지 확인 (AuthController에서 설정한 메시지)
                        if (typeof errorJson === 'string') {
                            // AuthController가 ResponseEntity.body("문자열")로 보낸 경우
                            userFriendlyMsg = errorJson;
                        } else if (errorJson.message) {
                            // Spring 기본 에러 JSON의 message 필드인 경우
                            userFriendlyMsg = errorJson.message;
                        } else {
                            // 그 외 알 수 없는 JSON인 경우 기본 메시지 사용
                            throw new Error("Unknown error format");
                        }

                    } catch (e) {
                        // JSON 파싱에 실패했거나 문자열 메시지인 경우, 받은 텍스트를 그대로 사용합니다.
                        // AuthController에서 ResponseEntity.body("아이디 또는...")처럼 보냈다면 이쪽으로 옵니다.
                        userFriendlyMsg = errorText;
                    }

                    // 3. 너무 기술적인 메시지(timestamp 등)가 포함되어 있으면 기본 메시지로 대체합니다.
                    if (!userFriendlyMsg || userFriendlyMsg.includes("timestamp") || userFriendlyMsg.includes("Internal Server Error")) {
                        userFriendlyMsg = "아이디와 비밀번호를 다시 확인해주세요.";
                    }

                    // 4. 최종적으로 깔끔한 메시지만 alert로 보여줍니다.
                    alert('로그인에 실패했습니다.\n' + userFriendlyMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                // 네트워크 오류 등
                alert('서버와 통신 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            }
        });
    </script>
</body>
</html>